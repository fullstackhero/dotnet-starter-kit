name: Code Quality & Coverage Gate

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  quality-gate:
    name: Quality & Coverage Gate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj', '**/Directory.Packages.props') }}
          restore-keys: |
            ${{ runner.os }}-nuget-
      - name: Restore dependencies
        run: make restore
      
      - name: Code Analysis
        id: analyze
        run: |
          echo "ğŸ” Running static code analysis..."
          if ! make analyze; then
            echo "âŒ Code analysis failed!"
            echo "analysis_failed=true" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "âœ… Code analysis passed"
          echo "analysis_failed=false" >> $GITHUB_OUTPUT
      
      - name: Show code analysis errors if failed
        if: failure() && steps.analyze.outputs.analysis_failed == 'true'
        run: |
          echo "ğŸ“‹ Code Analysis Error Details:"
          echo "==============================="
          cat code-analysis.txt || echo "No analysis file found"
      
      - name: Run unit tests with coverage
        id: tests
        run: |
          echo "ğŸ§ª Running unit tests with coverage..."
          if ! make test-unit-coverage; then
            echo "âŒ Unit tests failed!"
            echo "tests_failed=true" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "âœ… Unit tests passed"
          echo "tests_failed=false" >> $GITHUB_OUTPUT

      - name: Extract coverage percentage
        id: coverage
        run: |
          if [ ! -f "coverage-report/index.html" ]; then
            echo "âŒ Coverage report not found!"
            exit 1
          fi
          
          # Extract coverage percentage from HTML
          COVERAGE=$(grep -o 'cardpercentagebar[0-9]*">[0-9]*%' coverage-report/index.html | grep -o '[0-9]*%' | grep -o '[0-9]*' | head -1)
          
          if [ -z "$COVERAGE" ]; then
            echo "âŒ Could not extract coverage percentage!"
            exit 1
          fi
          
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          echo "ğŸ“Š Current coverage: $COVERAGE%"

      - name: Check coverage threshold
        id: coverage_gate
        run: |
          COVERAGE=${{ steps.coverage.outputs.coverage }}
          THRESHOLD=70
          
          echo "ğŸ“Š Coverage Analysis:"
          echo "====================="
          echo "Current Coverage: $COVERAGE%"
          echo "Required Threshold: $THRESHOLD%"
          echo ""
          
          if [ "$COVERAGE" -lt "$THRESHOLD" ]; then
            echo "âŒ COVERAGE GATE FAILED!"
            echo "Coverage $COVERAGE% is below required threshold of $THRESHOLD%"
            echo ""
            echo "ğŸ”§ Actions needed:"
            echo "- Add more unit tests"
            echo "- Improve test coverage for existing code"
            echo "- Check coverage report: coverage-report/index.html"
            echo "coverage_failed=true" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "âœ… COVERAGE GATE PASSED!"
            echo "Coverage $COVERAGE% meets the required threshold of $THRESHOLD%"
            echo "coverage_failed=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage-report/
          retention-days: 7

      - name: Comment PR with results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const coverage = ${{ steps.coverage.outputs.coverage || 0 }};
            const threshold = 70;
            const analysisStatus = '${{ steps.analyze.outputs.analysis_failed }}' !== 'true' ? 'âœ… PASSED' : 'âŒ FAILED';
            const testsStatus = '${{ steps.tests.outputs.tests_failed }}' !== 'true' ? 'âœ… PASSED' : 'âŒ FAILED';
            const coverageStatus = '${{ steps.coverage_gate.outputs.coverage_failed }}' !== 'true' ? 'âœ… PASSED' : 'âŒ FAILED';
            
            const overallStatus = analysisStatus.includes('âŒ') || testsStatus.includes('âŒ') || coverageStatus.includes('âŒ') ? 'âŒ' : 'âœ…';
            const emoji = overallStatus === 'âœ…' ? 'ğŸ‰' : 'âš ï¸';
            
            const comment = `## ${emoji} Code Quality & Coverage Report
            
            ### ğŸ“Š Quality Gates Status
            | Gate | Status |
            |------|--------|
            | **Code Analysis** | **${analysisStatus}** |
            | **Unit Tests** | **${testsStatus}** |
            | **Coverage** | **${coverageStatus}** (${coverage}%) |
            | **Threshold** | ${threshold}% |
            
            ### ï¿½ Summary
            ${overallStatus === 'âœ…'
              ? 'ğŸ¯ **All quality gates passed!** Ready to merge.' 
              : 'ğŸš« **Quality gates failed.** Please fix the issues before merging.'}
            
            ${overallStatus === 'âŒ' 
              ? `
            #### ğŸ”§ Required Actions:
            ${analysisStatus.includes('âŒ') ? '- Fix code analysis errors\n' : ''}${testsStatus.includes('âŒ') ? '- Fix failing unit tests\n' : ''}${coverageStatus.includes('âŒ') ? `- Increase test coverage to at least ${threshold}%\n` : ''}
            ` : ''}
            
            ğŸ“Š [View detailed reports](../actions/runs/${{ github.run_id }})`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Final status check
        if: always()
        run: |
          echo "ğŸ” Final Pipeline Status Check"
          echo "============================="
          
          ANALYSIS_FAILED="${{ steps.analyze.outputs.analysis_failed }}"
          TESTS_FAILED="${{ steps.tests.outputs.tests_failed }}"
          COVERAGE_FAILED="${{ steps.coverage_gate.outputs.coverage_failed }}"
          COVERAGE=${{ steps.coverage.outputs.coverage }}
          
          echo "ğŸ“Š Gate Results:"
          echo "- Code Analysis: $([ "$ANALYSIS_FAILED" = "true" ] && echo "âŒ FAILED" || echo "âœ… PASSED")"
          echo "- Unit Tests: $([ "$TESTS_FAILED" = "true" ] && echo "âŒ FAILED" || echo "âœ… PASSED")"
          echo "- Coverage Gate: $([ "$COVERAGE_FAILED" = "true" ] && echo "âŒ FAILED ($COVERAGE%)" || echo "âœ… PASSED ($COVERAGE%)")"
          echo ""
          
          if [ "$ANALYSIS_FAILED" = "true" ] || [ "$TESTS_FAILED" = "true" ] || [ "$COVERAGE_FAILED" = "true" ]; then
            echo "âŒ PIPELINE FAILED - Quality gates not met"
            echo "ğŸš« Commit/PR will be rejected"
            exit 1
          else
            echo "âœ… ALL QUALITY GATES PASSED"
            echo "ğŸ‰ Pipeline completed successfully"
          fi
